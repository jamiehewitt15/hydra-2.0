"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.startPromEndpoint = void 0;
const tslib_1 = require("tslib");
const express_1 = tslib_1.__importDefault(require("express"));
const prom_client_1 = require("prom-client");
const config_1 = require("../start/config");
const log_1 = require("../util/log");
function startPromEndpoint() {
    const server = express_1.default();
    // Setup server to Prometheus scrapes:
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    server.get('/metrics', (req, res) => {
        try {
            res.set('Content-Type', prom_client_1.register.contentType);
            res.end(prom_client_1.register.metrics());
        }
        catch (ex) {
            res.status(500).end(ex);
        }
    });
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    server.get('/metrics/:metricName', (req, res) => {
        try {
            res.set('Content-Type', prom_client_1.register.contentType);
            if (!req.params.metricName ||
                !prom_client_1.validateMetricName(req.params.metricName)) {
                res.status(400).end('No requested metric found');
            }
            res.end(prom_client_1.register.getSingleMetricAsString(req.params.metricName));
        }
        catch (ex) {
            res.status(500).end(ex);
        }
    });
    const port = config_1.conf.PROMETHEUS_PORT;
    const app = server.listen(port);
    log_1.info(`Prometheus server is listening on port ${port}. Hydra-Processor metrics are available at localhost:${port}/metrics`);
    return app;
}
exports.startPromEndpoint = startPromEndpoint;
//# sourceMappingURL=server.js.map